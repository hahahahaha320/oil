在es中，每秒清空一次写缓存，将这些数据写入文件，这个过程称为refresh，每次refresh会创建一个新的lucene端。分段数量太多会带来麻烦，消耗文件句柄、内存，影响查询速度。所以需要一定的策略将这些较小的段合并为大的段。
HBase、Cassandra等系统都有类似的分段机制，写过程中现在内存缓冲一批数据，不时地将这些数据写入文件作为一个分段，分段具有不变形，再通过一些策略合并分段。分段合并过程中，新段的产生需要一定的磁盘空间，如果段文件大小没有上限，超过磁盘空间的一半，剩余空间不足以进行新的段合并过程。而如果段文件设置一定上限不再合并，则对表中部分数据无法实现真正的物理删除。ES，Cassandra都存在这样的问题。
分布式系统的集群大致可分为主从模式和无主模式，ES，HDFS，HBase使用主从模式，Cassandra使用无主模式。

集群健康状态：
Green：所有的主、副分片都正常运行
Yellow：所有的主分片都正常运行，但不是所有的副分片都正常运行。
Red：有主分片没能正常运行。

es集群启动的整体流程：选主,主分片，数据恢复。
具体如下：elect master -> gateway -> alloaction -> recovery

elect master：选主算法是基于bully算法的改进，主要思路是对节点id排序，取id最大的节点作为master，每个节点都运行这个流程。有三个附加约定条件：参选人数过半，大道quorum（多数）；得票数需过半；当探测节点离开事件时，必须判断当前节点是否过半。

gateway：选举节点元信息：master被选出来之后，第一个任务是选举元信息，让各个节点把各自存储的元信息发过来，根据版本号确定最新的元信息，然后广播，这样所有节点都有了最新的元信息。
集群元信息包括两种类型：集群级和索引级。

alloaction：选举shard级元信息，构建内容路由表，包括选主分片和副分片。

index recovery:
根据translog来完成主分片的recovery。
副分片需要恢复成与主分片一致。


